<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gelişmiş Chat Uygulaması</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
    <style>
        body { background: linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%); }
        .chat-container { height: calc(100vh - 240px); overflow-y: auto; }
        .message-bubble { max-width: 70%; word-break: break-word; }
        .message-bubble img, .message-bubble video { max-width: 200px; max-height: 200px; }
        .admin-panel { display: none; }
        .emoji-picker { display: none; position: absolute; bottom: 60px; right: 0; background: white; border: 1px solid #ddd; border-radius: 5px; padding: 5px; }
        .emoji { cursor: pointer; font-size: 20px; padding: 5px; }
        .private-chat { display: none; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; }
        .typing-indicator { font-size: 12px; color: #888; }
        .status-online { background: green; }
        .status-offline { background: red; }
        .reaction { font-size: 20px; cursor: pointer; padding: 0 5px; }
        .reaction-list { display: flex; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center">
    <div class="container mx-auto p-4 max-w-4xl bg-white rounded-lg shadow-2xl">
        <h1 class="text-4xl font-bold mb-6 text-center text-gradient bg-gradient-to-r from-purple-400 via-pink-500 to-red-500">Gelişmiş Chat Uygulaması</h1>
        
        <div id="loginArea" class="mb-8">
            <input type="text" id="username" placeholder="Kullanıcı Adı" class="w-full p-3 mb-2 border rounded-lg shadow-sm focus:ring-2 focus:ring-purple-400 focus:border-transparent">
            <button onclick="login()" class="w-full bg-gradient-to-r from-purple-400 via-pink-500 to-red-500 text-white p-3 rounded-lg hover:opacity-90 transition duration-300 transform hover:scale-105">Giriş Yap</button>
        </div>

        <div id="chatArea" class="hidden">
            <div id="userList" class="flex justify-between mb-4">
                <div class="flex items-center space-x-2">
                    <div class="avatar" id="currentUserAvatar"></div>
                    <p id="currentUserStatus" class="text-sm"></p>
                </div>
                <button onclick="toggleAdminPanel()" class="bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600 transition duration-300">Admin Paneli</button>
            </div>
            <div id="messages" class="chat-container overflow-y-auto bg-gray-100 p-4 mb-4 border rounded-lg shadow-inner"></div>
            <div class="flex space-x-2 relative">
                <input type="text" id="messageInput" placeholder="Mesajınızı yazın" class="flex-grow p-3 border rounded-lg shadow-sm focus:ring-2 focus:ring-purple-400 focus:border-transparent">
                <input type="file" id="fileInput" accept="image/*,video/*" class="hidden">
                <button onclick="document.getElementById('fileInput').click()" class="bg-green-500 text-white p-3 rounded-lg hover:bg-green-600 transition duration-300 transform hover:scale-105"><i class="fas fa-paperclip"></i></button>
                <button onclick="toggleEmojiPicker()" class="bg-yellow-500 text-white p-3 rounded-lg hover:bg-yellow-600 transition duration-300 transform hover:scale-105"><i class="fas fa-smile"></i></button>
                <button onclick="sendMessage()" class="bg-gradient-to-r from-purple-400 via-pink-500 to-red-500 text-white p-3 rounded-lg hover:opacity-90 transition duration-300 transform hover:scale-105"><i class="fas fa-paper-plane"></i></button>
                <div id="emojiPicker" class="emoji-picker">
                    <span class="emoji" onclick="addEmoji('😊')">😊</span>
                    <span class="emoji" onclick="addEmoji('😂')">😂</span>
                    <span class="emoji" onclick="addEmoji('❤️')">❤️</span>
                    <span class="emoji" onclick="addEmoji('👍')">👍</span>
                    <span class="emoji" onclick="addEmoji('🎉')">🎉</span>
                    <!-- Daha fazla emoji eklenebilir -->
                </div>
            </div>
            <div id="typingIndicator" class="typing-indicator hidden">Bir kullanıcı yazıyor...</div>
        </div>

        <div id="privateChatArea" class="private-chat">
            <h2 id="privateChatHeader" class="text-2xl font-bold mb-4"></h2>
            <div id="privateMessages" class="chat-container overflow-y-auto bg-gray-100 p-4 mb-4 border rounded-lg shadow-inner"></div>
            <div class="flex space-x-2">
                <input type="text" id="privateMessageInput" placeholder="Özel mesajınızı yazın" class="flex-grow p-3 border rounded-lg shadow-sm focus:ring-2 focus:ring-purple-400 focus:border-transparent">
                <button onclick="sendPrivateMessage()" class="bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 transition duration-300 transform hover:scale-105"><i class="fas fa-paper-plane"></i></button>
            </div>
            <button onclick="closePrivateChat()" class="mt-4 bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition duration-300">Geri Dön</button>
        </div>

        <div id="adminPanel" class="admin-panel mt-8 bg-gray-100 p-6 rounded-lg shadow-lg">
            <h2 class="text-3xl font-bold mb-4 text-gradient bg-gradient-to-r from-purple-400 via-pink-500 to-red-500">Admin Paneli</h2>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <h3 class="text-xl font-semibold mb-2">İstatistikler</h3>
                    <p id="totalMessages" class="mb-1">Toplam Mesaj: 0</p>
                    <p id="totalUsers" class="mb-1">Toplam Kullanıcı: 0</p>
                    <p id="totalMedia" class="mb-1">Toplam Medya: 0</p>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-2">Hızlı İşlemler</h3>
                    <button onclick="deleteAllMessages()" class="bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition duration-300 w-full mb-2">Tüm Mesajları Sil</button>
                    <button onclick="banUser()" class="bg-yellow-500 text-white p-2 rounded-lg hover:bg-yellow-600 transition duration-300 w-full">Kullanıcı Banla</button>
                    <button onclick="unbanUser()" class="bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 transition duration-300 w-full mt-2">Kullanıcı Banını Kaldır</button>
                </div>
            </div>
            <div>
                <h3 class="text-xl font-semibold mb-2">Son Aktiviteler</h3>
                <ul id="activityLog" class="list-disc list-inside"></ul>
            </div>
            <div>
                <h3 class="text-xl font-semibold mb-2">Kullanıcı Yönetimi</h3>
                <ul id="adminUserList" class="list-disc list-inside"></ul>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD9q7CVsc6wlpgUoMpssNJyIJ9TqQ7IQeY",
            authDomain: "my-chat-app-97365.firebaseapp.com",
            databaseURL: "https://my-chat-app-97365-default-rtdb.firebaseio.com",
            projectId: "my-chat-app-97365",
            storageBucket: "my-chat-app-97365.appspot.com",
            messagingSenderId: "968416953406",
            appId: "1:968416953406:web:9e11d5bc3bbff0ffb23d6f"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage();

        const loginArea = document.getElementById('loginArea');
        const chatArea = document.getElementById('chatArea');
        const adminPanel = document.getElementById('adminPanel');
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const fileInput = document.getElementById('fileInput');
        const emojiPicker = document.getElementById('emojiPicker');
        const typingIndicator = document.getElementById('typingIndicator');
        const adminUserList = document.getElementById('adminUserList');
        const currentUserAvatar = document.getElementById('currentUserAvatar');
        const currentUserStatus = document.getElementById('currentUserStatus');

        let currentUser = null;
        let stats = { messages: 0, users: 0, media: 0 };

        function login() {
            const username = document.getElementById('username').value;
            if (username.trim() === '') {
                alert('Lütfen bir kullanıcı adı girin');
                return;
            }
            if (username === '623tk023') {
                currentUser = 'admin';
                adminPanel.style.display = 'block';
                updateAdminStats();
            } else {
                currentUser = username;
            }
            loginArea.style.display = 'none';
            chatArea.style.display = 'block';
            loadMessages();
            updateUserAvatarAndStatus();
            logActivity(`${currentUser} giriş yaptı`);
            updateUserCount(1);
        }

        async function sendMessage() {
            const message = messageInput.value;
            const file = fileInput.files[0];
            
            if (message.trim() === '' && !file) return;

            let fileUrl = '';
            let fileType = '';

            if (file) {
                const fileRef = storage.ref('uploads/' + Date.now() + '_' + file.name);
                await fileRef.put(file);
                fileUrl = await fileRef.getDownloadURL();
                fileType = file.type.startsWith('image') ? 'image' : 'video';
                stats.media++;
            }

            const messageId = database.ref('messages').push({
                username: currentUser,
                message: message,
                timestamp: Date.now(),
                fileUrl: fileUrl,
                fileType: fileType
            }).key;

            messageInput.value = '';
            fileInput.value = '';
            stats.messages++;
            updateAdminStats();

            if (currentUser === 'admin') {
                // Mesajı admin olarak gönderiyorsa, kullanıcılara bildirim gönder
                notifyUsers(`${currentUser} bir mesaj gönderdi`);
            }

            // Mesajı göster ve reaksiyon ekle
            displayMessage(messageId, message, currentUser, fileUrl, fileType);
        }

        function loadMessages() {
            const messagesRef = database.ref('messages');
            messagesRef.on('child_added', (snapshot) => {
                const data = snapshot.val();
                const messageId = snapshot.key;
                displayMessage(messageId, data.message, data.username, data.fileUrl, data.fileType);
            });
        }

        function displayMessage(id, message, username, fileUrl, fileType) {
            const messageElement = document.createElement('div');
            messageElement.className = `message-bubble ${username === currentUser ? 'ml-auto' : 'mr-auto'} mb-4 p-3 rounded-lg ${username === currentUser ? 'bg-purple-100' : 'bg-gray-200'}`;
            
            let usernameDisplay = username;
            if (username === 'admin') {
                usernameDisplay = '<strong class="text-red-600">admin</strong>';
            }

            let content = `<strong class="text-purple-600">${usernameDisplay}:</strong> ${message}`;
            
            if (fileUrl) {
                if (fileType === 'image') {
                    content += `<br><img src="${fileUrl}" alt="Yüklenen resim" class="mt-2 rounded shadow">`;
                } else if (fileType === 'video') {
                    content += `<br><video src="${fileUrl}" controls class="mt-2 rounded shadow"></video>`;
                }
            }

            // Reaksiyonlar için yer ayır
            const reactionList = document.createElement('div');
            reactionList.className = 'reaction-list mt-2';
            reactionList.innerHTML = `
                <span class="reaction" onclick="addReaction('${id}', '❤️')">❤️</span>
                <span class="reaction" onclick="addReaction('${id}', '👍')">👍</span>
                <span class="reaction" onclick="addReaction('${id}', '😂')">😂</span>
                <span class="reaction" onclick="addReaction('${id}', '😮')">😮</span>
            `;
            messageElement.appendChild(reactionList);

            messageElement.innerHTML = content;
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function deleteAllMessages() {
            if (confirm('Tüm mesajları silmek istediğinizden emin misiniz?')) {
                database.ref('messages').remove();
                messagesDiv.innerHTML = '';
                stats.messages = 0;
                stats.media = 0;
                updateAdminStats();
                logActivity('Tüm mesajlar silindi');
            }
        }

        function banUser() {
            const userToBan = prompt('Banlanacak kullanıcının adını girin:');
            if (userToBan) {
                database.ref('bannedUsers').push({ username: userToBan });
                logActivity(`${userToBan} kullanıcısı banlandı`);
                loadUsers();
            }
        }

        function unbanUser() {
            const userToUnban = prompt('Banı kaldırılacak kullanıcının adını girin:');
            if (userToUnban) {
                const bannedUsersRef = database.ref('bannedUsers');
                bannedUsersRef.once('value', (snapshot) => {
                    snapshot.forEach((childSnapshot) => {
                        if (childSnapshot.val().username === userToUnban) {
                            bannedUsersRef.child(childSnapshot.key).remove();
                            logActivity(`${userToUnban} kullanıcısının banı kaldırıldı`);
                            loadUsers();
                        }
                    });
                });
            }
        }

        function updateAdminStats() {
            document.getElementById('totalMessages').textContent = `Toplam Mesaj: ${stats.messages}`;
            document.getElementById('totalUsers').textContent = `Toplam Kullanıcı: ${stats.users}`;
            document.getElementById('totalMedia').textContent = `Toplam Medya: ${stats.media}`;
        }

        function logActivity(activity) {
            const activityLog = document.getElementById('activityLog');
            const li = document.createElement('li');
            li.textContent = `${new Date().toLocaleTimeString()} - ${activity}`;
            activityLog.insertBefore(li, activityLog.firstChild);
        }

        function toggleEmojiPicker() {
            emojiPicker.style.display = emojiPicker.style.display === 'none' ? 'block' : 'none';
        }

        function addEmoji(emoji) {
            messageInput.value += emoji;
            toggleEmojiPicker();
        }

        function addReaction(messageId, reaction) {
            const reactionRef = database.ref(`reactions/${messageId}/${currentUser}`);
            reactionRef.set(reaction);
        }

        function updateUserAvatarAndStatus() {
            currentUserAvatar.style.backgroundImage = `url('https://www.gravatar.com/avatar/${md5(currentUser)}?d=identicon')`;
            currentUserStatus.textContent = "Çevrimiçi";
            currentUserStatus.className = "status-online";
        }

        function loadUsers() {
            const usersRef = database.ref('users');
            usersRef.on('value', snapshot => {
                adminUserList.innerHTML = '';
                snapshot.forEach(userSnapshot => {
                    const user = userSnapshot.val();
                    const userItem = document.createElement('li');
                    userItem.textContent = user.username;
                    userItem.className = 'cursor-pointer';
                    userItem.onclick = () => openPrivateChat(user.username);
                    adminUserList.appendChild(userItem);
                });
            });
        }

        function notifyUsers(message) {
            const usersRef = database.ref('users');
            usersRef.once('value', snapshot => {
                snapshot.forEach(userSnapshot => {
                    const user = userSnapshot.val();
                    if (user.username !== currentUser) {
                        sendPrivateMessageToUser(user.username, message);
                    }
                });
            });
        }

        function sendPrivateMessageToUser(username, message) {
            database.ref('privateMessages').push({
                from: currentUser,
                to: username,
                message: message,
                timestamp: Date.now()
            });
        }

        function openPrivateChat(user) {
            // Özel mesajlaşma alanını aç
            document.getElementById('privateChatHeader').textContent = `${user} ile sohbet`;
            document.getElementById('privateChatArea').style.display = 'block';
            document.getElementById('chatArea').style.display = 'none';

            loadPrivateMessages(user);
        }

        function loadPrivateMessages(user) {
            const privateMessagesRef = database.ref('privateMessages');
            privateMessagesRef.on('child_added', (snapshot) => {
                const data = snapshot.val();
                if ((data.to === currentUser && data.from === user) || (data.to === user && data.from === currentUser)) {
                    const messageElement = document.createElement('div');
                    messageElement.className = `message-bubble ${data.from === currentUser ? 'ml-auto' : 'mr-auto'} mb-4 p-3 rounded-lg bg-gray-300`;
                    messageElement.innerHTML = `<strong>${data.from}:</strong> ${data.message}`;
                    document.getElementById('privateMessages').appendChild(messageElement);
                    document.getElementById('privateMessages').scrollTop = document.getElementById('privateMessages').scrollHeight;
                }
            });
        }

        function closePrivateChat() {
            document.getElementById('privateChatArea').style.display = 'none';
            document.getElementById('chatArea').style.display = 'block';
        }

        function updateUserCount(delta) {
            stats.users += delta;
            document.getElementById('totalUsers').textContent = `Toplam Kullanıcı: ${stats.users}`;
        }

        // Yazma göstergesi
        messageInput.addEventListener('keypress', () => {
            typingIndicator.style.display = 'block';
            setTimeout(() => {
                typingIndicator.style.display = 'none';
            }, 3000);
        });

        function toggleAdminPanel() {
            if (adminPanel.style.display === 'none' || adminPanel.style.display === '') {
                adminPanel.style.display = 'block';
            } else {
                adminPanel.style.display = 'none';
            }
        }

        // Kullanıcı takibi
        database.ref('messages').on('value', (snapshot) => {
            const messages = snapshot.val();
            if (messages) {
                const uniqueUsers = new Set(Object.values(messages).map(msg => msg.username));
                stats.users = uniqueUsers.size;
                updateAdminStats();
            }
        });
    </script>
</body>
</html>
